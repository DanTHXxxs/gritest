import os
import discord
import asyncio
import aiohttp
import pytz
from discord.ext import commands, tasks
from datetime import datetime


from myserver import server_on

# ‡πÇ‡∏´‡∏•‡∏î TOKEN ‡∏à‡∏≤‡∏Å Environment Variable
TOKEN = os.environ.get("DISCORD_TOKEN")


WEATHER_CHANNEL_ID = 1371471375361114182  # ‡πÅ‡∏ä‡∏ô‡πÅ‡∏ô‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
STATUS_CHANNEL_ID = 1371468773403660338  # ‡πÅ‡∏ä‡∏ô‡πÅ‡∏ô‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°
GUILD_ID = 905530303467094027
API_KEY = '56c594de7daca68b44c11aa5feb133d1'

intents = discord.Intents.default()
intents.members = True
intents.guilds = True
intents.presences = True

bot = commands.Bot(command_prefix="√ó", intents=intents)


LOCATIONS = {
    "‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠": [
        "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "‡∏•‡∏≥‡∏û‡∏π‡∏ô", "‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "‡πÅ‡∏û‡∏£‡πà", "‡∏ô‡πà‡∏≤‡∏ô", "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå", "‡∏ï‡∏≤‡∏Å", "‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£", "‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å", "‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£", "‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢"
    ],
    "‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠": [
        "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", "‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°", "‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î", "‡∏¢‡πÇ‡∏™‡∏ò‡∏£", "‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°", "‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£", "‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£", "‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢", "‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π", "‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨", "‡πÄ‡∏•‡∏¢", "‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©", "‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå", "‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥", "‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç", "‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå"
    ],
    "‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á": [
        "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£", "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤", "‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á", "‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó", "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°", "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ", "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ"
    ],
    "‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å": [
        "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏£‡∏∞‡∏¢‡∏≠‡∏á", "‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ï‡∏£‡∏≤‡∏î", "‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤", "‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß", "‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å"
    ],
    "‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å": [
        "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ", "‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå", "‡∏ï‡∏≤‡∏Å"
    ],
    "‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ": [
        "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä", "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", "‡∏™‡∏á‡∏Ç‡∏•‡∏≤", "‡∏û‡∏±‡∏á‡∏á‡∏≤", "‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà", "‡∏ï‡∏£‡∏±‡∏á", "‡∏£‡∏∞‡∏ô‡∏≠‡∏á", "‡∏™‡∏ï‡∏π‡∏•", "‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á", "‡∏¢‡∏∞‡∏•‡∏≤", "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ", "‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™", "‡∏ä‡∏∏‡∏°‡∏û‡∏£"
    ]
}

thai_days = {
    'Monday': '‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå',
    'Tuesday': '‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£',
    'Wednesday': '‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò',
    'Thursday': '‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ',
    'Friday': '‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå',
    'Saturday': '‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå',
    'Sunday': '‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'
}

thai_months = {
    'January': '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°',
    'February': '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå',
    'March': '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°',
    'April': '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô',
    'May': '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°',
    'June': '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
    'July': '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°',
    'August': '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°',
    'September': '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô',
    'October': '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°',
    'November': '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô',
    'December': '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
}

WEATHER_MESSAGE_ID = 1371491919401717770
STATUS_MESSAGE_ID = 1371491918076448798

async def get_weather(location):
    async with aiohttp.ClientSession() as session:
        url = f"http://api.openweathermap.org/data/2.5/weather?lat={location['lat']}&lon={location['lon']}&appid={API_KEY}&units=metric&lang=th"
        async with session.get(url) as response:
            data = await response.json()
            if response.status == 200:
                temp = data['main']['temp']
                desc = data['weather'][0]['description']
                return f"{location['name']}: {temp}¬∞C, {desc}"
            else:
                return f"{location['name']}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏£‡∏´‡∏±‡∏™ {response.status})"

@tasks.loop(minutes=1)
async def update_weather():
    global WEATHER_MESSAGE_ID
    weather_channel = bot.get_channel(WEATHER_CHANNEL_ID)

    lines = []
    for location in LOCATIONS:
        result = await get_weather(location)
        lines.append(result)

    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
    now = datetime.now(pytz.timezone("Asia/Bangkok"))
    day_th = thai_days[now.strftime('%A')]
    month_th = thai_months[now.strftime('%B')]
    year_th = now.year + 543
    update_time = f"{day_th} ‡∏ó‡∏µ‡πà {now.day} {month_th} ‡∏û.‡∏®. {year_th} ‡πÄ‡∏ß‡∏•‡∏≤ {now.strftime('%H:%M:%S')}"

    embed = discord.Embed(title="**‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® üå¶Ô∏è**", color=0x3399ff)
    embed.description = "\n".join(lines) + f"\n\n„Äî‚è∞„Äï‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠ {update_time}"
    embed.set_footer(text="„ÄîüîÑ„Äï‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡πÜ 1 ‡∏ô‡∏≤‡∏ó‡∏µ")

    try:
        if WEATHER_MESSAGE_ID:
            msg = await weather_channel.fetch_message(WEATHER_MESSAGE_ID)
            await msg.edit(embed=embed)
        else:
            msg = await weather_channel.send(embed=embed)
            WEATHER_MESSAGE_ID = msg.id
    except discord.NotFound:
        msg = await weather_channel.send(embed=embed)
        WEATHER_MESSAGE_ID = msg.id


@tasks.loop(seconds=10)
async def update_group_status():
    global STATUS_MESSAGE_ID
    guild = bot.get_guild(GUILD_ID)
    status_channel = bot.get_channel(STATUS_CHANNEL_ID)

    if not guild or not status_channel:
        return

    online = sum(1 for m in guild.members if m.status != discord.Status.offline)
    offline = guild.member_count - online

    # ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
    created_at = guild.created_at.astimezone(pytz.timezone("Asia/Bangkok"))
    day_th = thai_days[created_at.strftime('%A')]
    month_th = thai_months[created_at.strftime('%B')]
    year_th = created_at.year + 543  # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®.
    created_date_str = f"{day_th} {created_at.day} {month_th} {year_th} ‡πÄ‡∏ß‡∏•‡∏≤ {created_at.strftime('%H:%M:%S')}"

    embed = discord.Embed(title="**‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏û‡∏°‡πà‡∏≤ | ‡∏Ç‡∏≤‡∏¢‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏áüçó**", color=0x00cc99)
    embed.add_field(name="„Äîüî®„Äï‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠", value=created_date_str, inline=False)
    embed.add_field(name="„Äîüë•„Äï‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", value=f"{guild.member_count} ‡∏Ñ‡∏ô", inline=True)
    embed.add_field(name="„Äîüü¢„Äï‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå", value=f"{online} ‡∏Ñ‡∏ô", inline=True)
    embed.add_field(name="„Äî‚ö´„Äï‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå", value=f"{offline} ‡∏Ñ‡∏ô", inline=True)
    embed.set_footer(text="„ÄîüîÑ„Äï‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡πÜ 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ")

    try:
        if STATUS_MESSAGE_ID:
            msg = await status_channel.fetch_message(STATUS_MESSAGE_ID)
            await msg.edit(embed=embed)
        else:
            msg = await status_channel.send(embed=embed)
            STATUS_MESSAGE_ID = msg.id
    except discord.NotFound:
        msg = await status_channel.send(embed=embed)
        STATUS_MESSAGE_ID = msg.id

@bot.event
async def on_ready():
    print(f"‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡πá‡∏ô {bot.user}")
    update_weather.start()
    update_group_status.start()

server_on()

bot.run(TOKEN)
